import asyncio
import logging

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from app.database import async_session_maker
from app.models.knowledge_base import KnowledgeArticle, KnowledgeArticleVersion
from app.models.user import User

logger = logging.getLogger(__name__)

ARTICLES = [
    {
        "title": "Що робити, якщо порт зарядної станції не працює",
        "content": """## Проблема
Порт зарядної станції не реагує на підключення електромобіля.

## Діагностика
1. Перевірте індикатори на порту - чи горять вони
2. Спробуйте підключити інший електромобіль
3. Перевірте, чи не заблокований порт в системі

## Рішення
1. Перезавантажте станцію через панель керування
2. Перевірте з'єднання кабелів живлення
3. Якщо проблема залишається - створіть заявку на технічне обслуговування

## Коди помилок
- E001: Немає живлення на порту
- E002: Помилка комунікації з портом
- E003: Порт заблокований""",
        "category": "troubleshooting",
        "tags": ["порт", "не працює", "зарядка"],
        "station_models": ["ChargePoint CT4000", "ABB Terra AC"],
        "error_codes": ["E001", "E002", "E003"]
    },
    {
        "title": "Помилка E001: Немає живлення на порту",
        "content": """## Опис помилки
Порт зарядної станції не отримує живлення від основного блоку.

## Причини
- Вимкнений автоматичний вимикач
- Пошкоджений кабель живлення
- Несправність внутрішнього блоку живлення

## Кроки усунення
1. Перевірте стан автоматичних вимикачів
2. Візуально оцініть стан кабелів
3. Виміряйте напругу на вході порту (тільки для технічних спеціалістів)
4. При необхідності замініть блок живлення""",
        "category": "troubleshooting",
        "tags": ["помилка", "живлення", "E001"],
        "error_codes": ["E001"]
    },
    {
        "title": "Як перезавантажити зарядну станцію",
        "content": """## Коли потрібно перезавантаження
- Станція не реагує на команди
- Помилки комунікації
- Після оновлення програмного забезпечення

## Процедура перезавантаження
1. Переконайтеся, що жодна зарядка не активна
2. Увійдіть в адміністративну панель
3. Виберіть "Обслуговування" → "Перезавантаження"
4. Підтвердіть дію
5. Зачекайте 2-3 хвилини до повного завантаження

## Альтернативний метод
Якщо панель недоступна - вимкніть живлення на 30 секунд, потім увімкніть знову.""",
        "category": "how-to",
        "tags": ["перезавантаження", "обслуговування"],
        "station_models": ["ChargePoint CT4000", "ABB Terra AC", "EVBox Troniq"]
    },
    {
        "title": "Станція не підключається до мережі",
        "content": """## Симптоми
- Відсутність зв'язку з центральною системою
- Неможливість розпочати зарядку через додаток
- Індикатор мережі не горить

## Перевірка
1. Перевірте Ethernet кабель (якщо використовується)
2. Перевірте налаштування Wi-Fi
3. Переконайтеся, що роутер працює
4. Перевірте наявність інтернету

## Рішення
1. Перепідключіть мережевий кабель
2. Перезавантажте роутер
3. Перевірте налаштування мережі в панелі станції
4. Зверніться до IT-відділу для перевірки firewall""",
        "category": "troubleshooting",
        "tags": ["мережа", "підключення", "інтернет"],
        "error_codes": ["E100", "E101"]
    },
    {
        "title": "Помилка E050: Перегрів станції",
        "content": """## Опис
Температура внутрішніх компонентів перевищила допустиму норму.

## Причини
- Висока температура навколишнього середовища
- Недостатня вентиляція
- Несправність системи охолодження
- Тривала робота на максимальній потужності

## Дії
1. Припиніть зарядку
2. Дайте станції охолонути 15-20 хвилин
3. Перевірте вентиляційні отвори - чи не заблоковані вони
4. Якщо помилка повторюється - викличте технічного спеціаліста""",
        "category": "troubleshooting",
        "tags": ["перегрів", "температура", "охолодження"],
        "error_codes": ["E050", "E051"]
    },
    {
        "title": "Як додати нову RFID картку",
        "content": """## Процедура додавання картки
1. Увійдіть в адміністративну панель
2. Перейдіть в розділ "Користувачі"
3. Виберіть користувача або створіть нового
4. Натисніть "Додати RFID картку"
5. Прикладіть картку до зчитувача станції
6. Система автоматично зчитає ID картки
7. Збережіть зміни

## Важливо
- Одна картка може бути прив'язана тільки до одного користувача
- Для видалення картки використовуйте кнопку "Видалити" біля ID картки""",
        "category": "how-to",
        "tags": ["RFID", "картка", "авторизація"],
        "station_models": ["ChargePoint CT4000", "ABB Terra AC", "EVBox Troniq"]
    },
    {
        "title": "Зарядка припиняється через 5 хвилин",
        "content": """## Проблема
Зарядка автоматично зупиняється незабаром після початку.

## Можливі причини
1. Проблеми з комунікацією між станцією та автомобілем
2. Несправність кабелю
3. Перевантаження мережі
4. Налаштування обмеження часу

## Діагностика
1. Перевірте журнал помилок станції
2. Спробуйте інший порт
3. Перевірте налаштування профілю зарядки
4. Перевірте стан роз'єму кабелю

## Рішення
- Очистіть контакти роз'єму
- Перезавантажте станцію
- Перевірте налаштування таймерів""",
        "category": "troubleshooting",
        "tags": ["зупинка", "зарядка", "переривання"],
        "error_codes": ["E020", "E021"]
    },
    {
        "title": "Як налаштувати розклад роботи станції",
        "content": """## Налаштування розкладу
1. Відкрийте веб-інтерфейс станції
2. Перейдіть в "Налаштування" → "Розклад"
3. Виберіть дні тижня
4. Встановіть години роботи
5. Збережіть налаштування

## Додаткові опції
- Різні розклади для будніх та вихідних
- Обмеження потужності в пікові години
- Автоматичне вимкнення в неробочий час

## Примітка
Активні сесії зарядки не будуть перервані при настанні неробочого часу.""",
        "category": "how-to",
        "tags": ["розклад", "налаштування", "робочі години"]
    },
    {
        "title": "Помилка E200: Помилка зчитувача RFID",
        "content": """## Опис помилки
Зчитувач RFID карток не працює або працює некоректно.

## Симптоми
- Картка не розпізнається
- Затримка при зчитуванні
- Індикатор зчитувача не реагує

## Рішення
1. Перезавантажте станцію
2. Перевірте чистоту поверхні зчитувача
3. Спробуйте іншу картку
4. Перевірте підключення зчитувача (для технічних спеціалістів)
5. При необхідності замініть зчитувач

## Тимчасове рішення
Використовуйте мобільний додаток для авторизації.""",
        "category": "troubleshooting",
        "tags": ["RFID", "зчитувач", "картка"],
        "error_codes": ["E200", "E201", "E202"]
    },
    {
        "title": "Низька швидкість зарядки",
        "content": """## Проблема
Зарядка відбувається повільніше, ніж очікувалося.

## Причини
1. Обмеження потужності станції
2. Обмеження з боку автомобіля
3. Висока температура батареї
4. Низька напруга в мережі
5. Налаштування профілю зарядки

## Перевірка
- Подивіться поточну потужність на дисплеї станції
- Перевірте налаштування в автомобілі
- Перевірте температуру батареї
- Перевірте напругу мережі

## Рішення
- Зачекайте охолодження батареї
- Змініть налаштування профілю зарядки
- Перевірте електричну мережу""",
        "category": "troubleshooting",
        "tags": ["швидкість", "повільна зарядка", "потужність"]
    },
    {
        "title": "Як оновити прошивку станції",
        "content": """## Підготовка
1. Переконайтеся, що станція підключена до інтернету
2. Переконайтеся, що жодна зарядка не активна
3. Зробіть резервну копію налаштувань

## Процес оновлення
1. Увійдіть в адміністративну панель
2. Перейдіть в "Система" → "Оновлення"
3. Натисніть "Перевірити оновлення"
4. Якщо доступне оновлення - натисніть "Встановити"
5. Зачекайте завершення (10-15 хвилин)
6. Станція автоматично перезавантажиться

## Важливо
- Не вимикайте живлення під час оновлення
- Після оновлення перевірте всі функції""",
        "category": "how-to",
        "tags": ["оновлення", "прошивка", "firmware"],
        "station_models": ["ChargePoint CT4000", "ABB Terra AC", "EVBox Troniq"]
    },
    {
        "title": "Помилка E300: Помилка вимірювання енергії",
        "content": """## Опис
Лічильник енергії не працює або показує некоректні дані.

## Наслідки
- Неточний облік спожитої енергії
- Неможливість виставлення рахунків
- Помилки в звітності

## Діагностика
1. Перевірте підключення лічильника
2. Перевірте калібрування
3. Порівняйте показники з іншими джерелами

## Рішення
1. Перезавантажте станцію
2. Виконайте калібрування лічильника
3. Перевірте налаштування в системі
4. При необхідності замініть лічильник""",
        "category": "troubleshooting",
        "tags": ["лічильник", "енергія", "облік"],
        "error_codes": ["E300", "E301", "E302"]
    },
    {
        "title": "Як налаштувати тарифи на зарядку",
        "content": """## Налаштування тарифів
1. Увійдіть в систему керування
2. Перейдіть в "Налаштування" → "Тарифи"
3. Створіть новий тариф або редагуйте існуючий
4. Встановіть ціну за кВт·год
5. Налаштуйте різні тарифи для різного часу доби
6. Збережіть зміни

## Типи тарифів
- Фіксований (однакова ціна завжди)
- Погодинний (різна ціна в різний час)
- Пільговий (для певних груп користувачів)

## Застосування
Тарифи застосовуються автоматично при початку зарядки.""",
        "category": "how-to",
        "tags": ["тарифи", "ціни", "оплата"]
    },
    {
        "title": "Станція не авторизує користувача",
        "content": """## Проблема
Користувач не може розпочати зарядку через помилку авторизації.

## Причини
1. Картка не зареєстрована в системі
2. Обліковий запис заблокований
3. Недостатньо коштів на балансі
4. Проблеми з підключенням до сервера авторизації

## Перевірка
- Перевірте статус облікового запису
- Перевірте баланс користувача
- Перевірте підключення до інтернету
- Перегляньте журнал помилок

## Рішення
1. Переконайтеся, що картка активна
2. Поповніть баланс
3. Перевірте мережеве підключення
4. Використайте альтернативний метод авторизації""",
        "category": "troubleshooting",
        "tags": ["авторизація", "користувач", "доступ"],
        "error_codes": ["E400", "E401", "E402"]
    },
    {
        "title": "Як переглянути історію зарядок",
        "content": """## Доступ до історії
1. Увійдіть в адміністративну панель
2. Перейдіть в розділ "Звіти"
3. Виберіть "Історія зарядок"
4. Встановіть фільтри (дата, користувач, станція)
5. Натисніть "Показати"

## Доступна інформація
- Дата та час початку/завершення
- Тривалість зарядки
- Спожита енергія
- Вартість
- Користувач
- Станція та порт

## Експорт даних
Історію можна експортувати в форматах CSV, Excel, PDF.""",
        "category": "how-to",
        "tags": ["історія", "звіти", "статистика"]
    },
    {
        "title": "Помилка E500: Помилка комунікації з автомобілем",
        "content": """## Опис
Станція не може встановити зв'язок з автомобілем.

## Симптоми
- Зарядка не починається
- Повідомлення про помилку на дисплеї
- Автомобіль не розпізнає станцію

## Причини
1. Забруднені контакти роз'єму
2. Пошкоджений кабель
3. Несумісність протоколів
4. Проблема з автомобілем

## Рішення
1. Очистіть контакти роз'єму
2. Спробуйте інший кабель/порт
3. Перезавантажте станцію
4. Перезавантажте систему автомобіля
5. Перевірте сумісність моделі автомобіля""",
        "category": "troubleshooting",
        "tags": ["комунікація", "автомобіль", "зв'язок"],
        "error_codes": ["E500", "E501", "E502"]
    },
    {
        "title": "Як налаштувати сповіщення",
        "content": """## Типи сповіщень
- Email сповіщення
- SMS сповіщення
- Push-сповіщення в додатку
- Telegram сповіщення

## Налаштування
1. Увійдіть в особистий кабінет
2. Перейдіть в "Налаштування" → "Сповіщення"
3. Виберіть події для сповіщень:
   - Початок зарядки
   - Завершення зарядки
   - Помилки
   - Низький баланс
4. Виберіть канали доставки
5. Збережіть налаштування

## Рекомендації
Увімкніть сповіщення про помилки для швидкого реагування.""",
        "category": "how-to",
        "tags": ["сповіщення", "налаштування", "повідомлення"]
    },
    {
        "title": "Дисплей станції не працює",
        "content": """## Проблема
Дисплей станції не показує інформацію або показує некоректно.

## Діагностика
1. Перевірте, чи горить підсвітка
2. Перевірте, чи реагує сенсорний екран
3. Спробуйте перезавантажити станцію

## Можливі причини
- Програмний збій
- Пошкодження дисплея
- Проблеми з підключенням
- Несправність контролера

## Рішення
1. Перезавантажте станцію
2. Перевірте підключення шлейфа дисплея
3. Оновіть прошивку
4. При необхідності замініть дисплей

## Тимчасове рішення
Використовуйте мобільний додаток або веб-інтерфейс.""",
        "category": "troubleshooting",
        "tags": ["дисплей", "екран", "інтерфейс"],
        "error_codes": ["E600", "E601"]
    },
    {
        "title": "Як створити звіт про використання",
        "content": """## Створення звіту
1. Увійдіть в систему керування
2. Перейдіть в "Звіти" → "Використання"
3. Виберіть період звітності
4. Виберіть станції для включення в звіт
5. Виберіть формат звіту (PDF, Excel, CSV)
6. Натисніть "Створити звіт"

## Дані в звіті
- Загальна кількість зарядок
- Спожита енергія
- Виручка
- Середня тривалість зарядки
- Найактивніші користувачі
- Графіки використання

## Автоматичні звіти
Можна налаштувати автоматичну відправку звітів на email.""",
        "category": "how-to",
        "tags": ["звіти", "статистика", "аналітика"]
    },
    {
        "title": "Помилка E700: Витік струму на землю",
        "content": """## УВАГА! НЕБЕЗПЕЧНА ПОМИЛКА
Виявлено витік струму, що може становити небезпеку.

## Дії
1. НЕГАЙНО припиніть використання станції
2. Відключіть живлення
3. Огородіть зону доступу
4. Викличте кваліфікованого електрика

## Причини
- Пошкодження ізоляції
- Проникнення вологи
- Несправність захисного обладнання

## Важливо
НЕ намагайтеся самостійно усунути проблему!
Це може бути небезпечно для життя!""",
        "category": "troubleshooting",
        "tags": ["витік", "безпека", "аварія"],
        "error_codes": ["E700", "E701"]
    },
    {
        "title": "Як налаштувати резервування часу зарядки",
        "content": """## Функція резервування
Дозволяє користувачам заздалегідь забронювати час для зарядки.

## Налаштування для адміністратора
1. Увійдіть в панель керування
2. Перейдіть в "Налаштування" → "Резервування"
3. Увімкніть функцію резервування
4. Встановіть мінімальний/максимальний час резервування
5. Встановіть вартість резервування (опціонально)
6. Збережіть налаштування

## Для користувачів
1. Відкрийте додаток
2. Виберіть станцію
3. Натисніть "Зарезервувати"
4. Виберіть дату та час
5. Підтвердіть резервування""",
        "category": "how-to",
        "tags": ["резервування", "бронювання", "час"]
    },
    {
        "title": "Станція не реагує на команди з додатку",
        "content": """## Проблема
Неможливо керувати станцією через мобільний додаток або веб-інтерфейс.

## Перевірка
1. Перевірте підключення до інтернету на пристрої
2. Перевірте підключення станції до мережі
3. Перевірте статус серверів в додатку
4. Спробуйте вийти та увійти знову

## Рішення
1. Перезапустіть додаток
2. Перевірте мережеві налаштування станції
3. Перезавантажте станцію
4. Перевірте firewall та порти
5. Зверніться до служби підтримки

## Тимчасове рішення
Використовуйте локальне керування через дисплей станції.""",
        "category": "troubleshooting",
        "tags": ["додаток", "керування", "команди"],
        "error_codes": ["E800", "E801"]
    },
    {
        "title": "Як налаштувати інтеграцію з платіжною системою",
        "content": """## Підтримувані платіжні системи
- Visa/Mastercard
- Apple Pay / Google Pay
- PayPal
- Локальні платіжні системи

## Налаштування
1. Увійдіть в панель керування
2. Перейдіть в "Налаштування" → "Платежі"
3. Виберіть платіжну систему
4. Введіть API ключі від платіжного провайдера
5. Налаштуйте валюту
6. Протестуйте підключення
7. Збережіть налаштування

## Безпека
Всі платіжні дані шифруються та відповідають стандарту PCI DSS.""",
        "category": "how-to",
        "tags": ["платежі", "оплата", "інтеграція"]
    },
    {
        "title": "Помилка E900: Перевантаження мережі",
        "content": """## Опис
Споживання енергії перевищує допустимі межі.

## Причини
1. Одночасна зарядка багатьох автомобілів
2. Недостатня потужність електромережі
3. Неправильні налаштування розподілу навантаження

## Наслідки
- Автоматичне зниження потужності зарядки
- Можливе відключення деяких портів
- Збільшення часу зарядки

## Рішення
1. Налаштуйте динамічний розподіл навантаження
2. Обмежте кількість одночасних зарядок
3. Розгляньте можливість збільшення потужності підключення
4. Використовуйте розумне планування зарядок""",
        "category": "troubleshooting",
        "tags": ["перевантаження", "потужність", "навантаження"],
        "error_codes": ["E900", "E901"]
    },
    {
        "title": "Як налаштувати динамічний розподіл навантаження",
        "content": """## Що таке динамічний розподіл навантаження
Автоматичне регулювання потужності зарядки для оптимального використання доступної електроенергії.

## Налаштування
1. Увійдіть в панель керування
2. Перейдіть в "Налаштування" → "Управління навантаженням"
3. Увімкніть динамічний розподіл
4. Встановіть максимальну доступну потужність
5. Встановіть пріоритети портів (опціонально)
6. Збережіть налаштування

## Переваги
- Запобігання перевантаженню
- Оптимальне використання енергії
- Можливість зарядки більшої кількості автомобілів""",
        "category": "how-to",
        "tags": ["навантаження", "розподіл", "оптимізація"]
    },
    {
        "title": "Кабель застряг в роз'ємі",
        "content": """## Проблема
Зарядний кабель не виймається з роз'єму автомобіля або станції.

## Причини
1. Активна блокування під час зарядки
2. Механічна несправність замка
3. Обмерзання в холодну погоду
4. Програмний збій

## Рішення
1. Переконайтеся, що зарядка завершена
2. Розблокуйте автомобіль
3. Спробуйте розблокувати через додаток
4. Для станції - використайте аварійне розблокування
5. В холодну погоду - зачекайте відтанення

## Аварійне розблокування
Використовуйте спеціальний ключ (зазвичай в комплекті зі станцією).""",
        "category": "troubleshooting",
        "tags": ["кабель", "застряг", "блокування"]
    },
    {
        "title": "Як налаштувати групи користувачів",
        "content": """## Призначення груп
Групи дозволяють керувати доступом та тарифами для різних категорій користувачів.

## Створення групи
1. Увійдіть в панель керування
2. Перейдіть в "Користувачі" → "Групи"
3. Натисніть "Створити групу"
4. Введіть назву та опис
5. Встановіть права доступу
6. Призначте тариф
7. Збережіть групу

## Додавання користувачів
1. Відкрийте профіль користувача
2. Виберіть групу зі списку
3. Збережіть зміни

## Приклади груп
- Співробітники
- VIP клієнти
- Гості
- Тестові користувачі""",
        "category": "how-to",
        "tags": ["групи", "користувачі", "доступ"]
    },
    {
        "title": "Помилка E1000: Несправність контактора",
        "content": """## Опис
Контактор (реле високої потужності) не спрацьовує або працює некоректно.

## Симптоми
- Клацання при спробі почати зарядку
- Зарядка не починається
- Переривчаста подача енергії

## Причини
1. Зношення контактів
2. Проблеми з котушкою
3. Перегрів
4. Механічне пошкодження

## Дії
1. Припиніть використання станції
2. Перезавантажте станцію
3. Якщо помилка повторюється - викличте технічного спеціаліста
4. Контактор потребує заміни

## Важливо
Несправний контактор може призвести до пожежі!""",
        "category": "troubleshooting",
        "tags": ["контактор", "реле", "несправність"],
        "error_codes": ["E1000", "E1001"]
    },
    {
        "title": "Як виконати діагностику станції",
        "content": """## Режим діагностики
1. Увійдіть в адміністративну панель
2. Перейдіть в "Обслуговування" → "Діагностика"
3. Виберіть тип діагностики:
   - Швидка перевірка
   - Повна діагностика
   - Тест окремих компонентів
4. Запустіть діагностику
5. Дочекайтеся завершення

## Що перевіряється
- Живлення та напруга
- Комунікаційні модулі
- Лічильник енергії
- RFID зчитувач
- Контактори
- Датчики температури
- Мережеве підключення

## Результати
Звіт про діагностику можна зберегти або надіслати в службу підтримки.""",
        "category": "how-to",
        "tags": ["діагностика", "тестування", "перевірка"]
    },
    {
        "title": "Станція показує некоректний час",
        "content": """## Проблема
Час на станції не відповідає реальному.

## Причини
1. Відсутність підключення до NTP сервера
2. Неправильний часовий пояс
3. Розряджена батарея годинника
4. Програмний збій

## Рішення
1. Перевірте підключення до інтернету
2. Налаштуйте NTP сервер:
   - Панель керування → Система → Дата і час
   - Увімкніть автоматичну синхронізацію
   - Вкажіть NTP сервер (наприклад, pool.ntp.org)
3. Встановіть правильний часовий пояс
4. Збережіть налаштування

## Важливість правильного часу
Некоректний час впливає на тарифікацію та звітність.""",
        "category": "troubleshooting",
        "tags": ["час", "дата", "синхронізація"]
    },
    {
        "title": "Як налаштувати резервне копіювання",
        "content": """## Що копіюється
- Налаштування станцій
- База користувачів
- Історія зарядок
- Журнали подій
- Тарифи та групи

## Налаштування автоматичного резервного копіювання
1. Увійдіть в панель керування
2. Перейдіть в "Система" → "Резервне копіювання"
3. Увімкніть автоматичне копіювання
4. Встановіть розклад (щоденно, щотижня)
5. Виберіть місце збереження (локально, хмара, FTP)
6. Збережіть налаштування

## Відновлення з резервної копії
1. Система → Резервне копіювання → Відновити
2. Виберіть файл резервної копії
3. Підтвердіть відновлення
4. Зачекайте завершення""",
        "category": "how-to",
        "tags": ["резервне копіювання", "backup", "відновлення"]
    },
    {
        "title": "Помилка E1100: Невідповідність версій протоколу",
        "content": """## Опис
Версія протоколу зарядки автомобіля не сумісна зі станцією.

## Причини
1. Застаріла прошивка станції
2. Дуже новий автомобіль з новим протоколом
3. Регіональні відмінності в стандартах

## Рішення
1. Оновіть прошивку станції до останньої версії
2. Перевірте сумісність моделі автомобіля
3. Спробуйте іншу станцію
4. Зверніться до виробника для уточнення сумісності

## Підтримувані протоколи
- IEC 61851
- ISO 15118
- CHAdeMO
- CCS (Combined Charging System)""",
        "category": "troubleshooting",
        "tags": ["протокол", "сумісність", "версія"],
        "error_codes": ["E1100", "E1101"]
    },
    {
        "title": "Як налаштувати моніторинг станцій",
        "content": """## Система моніторингу
Дозволяє відстежувати стан всіх станцій в реальному часі.

## Налаштування
1. Увійдіть в панель керування
2. Перейдіть в "Моніторинг" → "Налаштування"
3. Увімкніть моніторинг
4. Налаштуйте параметри відстеження:
   - Стан підключення
   - Активні зарядки
   - Помилки та попередження
   - Споживання енергії
5. Налаштуйте сповіщення про критичні події
6. Збережіть налаштування

## Дашборд моніторингу
Показує:
- Карту станцій
- Статус кожної станції
- Поточні зарядки
- Статистику в реальному часі""",
        "category": "how-to",
        "tags": ["моніторинг", "відстеження", "контроль"]
    },
    {
        "title": "Зарядка завершується з помилкою оплати",
        "content": """## Проблема
Зарядка проходить успішно, але виникає помилка при списанні коштів.

## Причини
1. Недостатньо коштів на балансі
2. Проблеми з платіжною системою
3. Заблокована картка
4. Помилка в налаштуваннях тарифів

## Перевірка
1. Перевірте баланс користувача
2. Перевірте статус платіжної системи
3. Перегляньте журнал транзакцій
4. Перевірте налаштування тарифів

## Рішення
1. Поповніть баланс
2. Оновіть платіжні дані
3. Перевірте підключення до платіжної системи
4. Виконайте повторну спробу списання""",
        "category": "troubleshooting",
        "tags": ["оплата", "платіж", "баланс"],
        "error_codes": ["E1200", "E1201"]
    },
    {
        "title": "Як налаштувати доступ за розкладом",
        "content": """## Обмеження доступу за часом
Дозволяє контролювати, коли користувачі можуть використовувати станції.

## Налаштування для групи користувачів
1. Увійдіть в панель керування
2. Перейдіть в "Користувачі" → "Групи"
3. Виберіть групу або створіть нову
4. Перейдіть на вкладку "Розклад доступу"
5. Встановіть дозволені години для кожного дня тижня
6. Збережіть налаштування

## Налаштування для окремої станції
1. Перейдіть в "Станції"
2. Виберіть станцію
3. Вкладка "Доступ"
4. Налаштуйте розклад роботи
5. Збережіть

## Приклади використання
- Обмеження доступу гостей до робочих годин
- Пріоритетний доступ для співробітників""",
        "category": "how-to",
        "tags": ["доступ", "розклад", "обмеження"]
    },
    {
        "title": "Часті питання про зарядку електромобілів",
        "content": """## Скільки часу займає зарядка?
Залежить від:
- Ємності батареї автомобіля
- Потужності станції
- Поточного рівня заряду
Зазвичай: 30 хвилин - 8 годин

## Чи можна залишати автомобіль на зарядці на ніч?
Так, сучасні автомобілі та станції автоматично припиняють зарядку при досягненні 100%.

## Чи безпечно заряджати під дощем?
Так, зарядні станції мають захист від вологи (IP54 або вище).

## Що таке AC та DC зарядка?
- AC (змінний струм) - повільна зарядка, 3-22 кВт
- DC (постійний струм) - швидка зарядка, 50-350 кВт

## Чи можна використовувати будь-яку станцію?
Так, якщо роз'єм підходить до вашого автомобіля.""",
        "category": "faq",
        "tags": ["FAQ", "питання", "зарядка"]
    },
]


async def seed_knowledge_base():
    """Seed knowledge base with articles."""
    logger.info("Starting knowledge base seeding...")

    async with async_session_maker() as db:
        try:
            # Get admin user
            result = await db.execute(
                select(User).where(User.email == "admin@skai.ua")
            )
            admin = result.scalar_one_or_none()

            if not admin:
                logger.error("Admin user not found. Please run seed_initial_data first.")
                return

            # Create articles
            created_count = 0
            for article_data in ARTICLES:
                # Check if article already exists
                existing = await db.execute(
                    select(KnowledgeArticle).where(
                        KnowledgeArticle.title == article_data["title"]
                    )
                )
                if existing.scalar_one_or_none():
                    logger.info(f"Article '{article_data['title']}' already exists, skipping")
                    continue

                article = KnowledgeArticle(
                    author_id=admin.id,
                    is_published=True,
                    **article_data
                )
                db.add(article)
                await db.flush()

                # Create initial version
                version = KnowledgeArticleVersion(
                    article_id=article.id,
                    version=1,
                    title=article.title,
                    content=article.content,
                    editor_id=admin.id,
                )
                db.add(version)
                created_count += 1

            await db.commit()
            logger.info(f"Created {created_count} knowledge base articles!")

        except Exception as e:
            await db.rollback()
            logger.error(f"Knowledge base seeding failed: {e}")
            raise


if __name__ == "__main__":
    asyncio.run(seed_knowledge_base())
